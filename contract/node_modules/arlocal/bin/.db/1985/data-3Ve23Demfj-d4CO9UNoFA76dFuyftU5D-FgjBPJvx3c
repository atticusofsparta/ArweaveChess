Ci8qKioKICogY29udHJhY3QgY3JlYXRlZCBieSBBdHRpY3VzCiAqLwpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlKHN0YXRlLCBhY3Rpb24pewoKICAgIHN3aXRjaCAoYWN0aW9uLmlucHV0LmZ1bmN0aW9uKSB7CiAgICAgICAgY2FzZSAnbmFtZSc6IHsgLy8gcmV0dXJucyBjb250cmFjdCBuYW1lCiAgICAgICAgICByZXR1cm4geyByZXN1bHQ6IHN0YXRlLm5hbWUgfTsKICAgICAgICB9CiAgICAgICAgY2FzZSAnbWV0aG9kcyc6IHsgLy8gcmV0dXJucyBhbGwgbWV0aG9kcyBhdmFpbGFibGUgaW4gdGhpcyBjb250cmFjdAogICAgICAgICAgICByZXR1cm4geyByZXN1bHQ6IFsKICAgICAgICAgICAgICAgIHtuYW1lOiAicmV0dXJucyB0aGUgbmFtZSBvZiB0aGUgY29udHJhY3QifSwgCiAgICAgICAgICAgICAgICB7bWV0aG9kczogInJldHVybnMgYSBsaXN0IG9mIGFsbCB0aGUgY29udHJhY3QgbWV0aG9kcyBhbmQgZGVzY3JpcHRpb25zIn0sIAogICAgICAgICAgICAgICAge2FsbEFzc2V0czogInJldHVybnMgYWxsIGFzc2V0cyBpbiB0aGUgY29udHJhY3QifSwgCiAgICAgICAgICAgICAgICB7Z2V0QXNzZXREYXRhOiAiR2V0cyBhbGwgZGF0YSBmb3IgYSBzcGVjaWZpZWQgYXNzZXQifSwKICAgICAgICAgICAgICAgIHtnZXRBc3NldHNJbkNvbGxlY3Rpb246ICJHZXRzIGEgbGlzdCBvZiBhbGwgdGhlIGFzc2V0cyBpbiBhIGdpdmVuIGNvbGxlY3Rpb24uIn0sCiAgICAgICAgICAgICAgICB7Z2V0QXNzZXRzT3duZWRCeUNhbGxlcjogInJldHVybnMgYWxsIGFzc2V0cyBvd25lZCBieSB0aGUgY2FsbGVyIG9mIHRoZSBmdW5jdGlvbiwgcmV0dXJucyBjb2xsZWN0aW9uLCBhc3NldCwgYW5kIHRydWUgb3IgZmFsc2UgaWYgdGhleSBvd24gaXQuIn0sIAogICAgICAgICAgICAgICAge2dldE93bmVyczogInJldHVybnMgYWxsIHRoZSBvd25lcnMgb2YgYW4gYXNzZXQifSwgCiAgICAgICAgICAgICAgICB7Y3JlYXRlQXNzZXQ6ICJjcmVhdGVzIGEgbmV3IGFzc2V0IGluIHRoZSBjb250cmFjdCJ9LCAKICAgICAgICAgICAgICAgIHtjcmVhdGVDb2xsZWN0aW9uOiAiQ3JlYXRlcyBhIGNvbGxlY3Rpb24gdG8gaG9sZCBhIHJhbmdlIG9mIGFzc2V0cy4ifSwKICAgICAgICAgICAgICAgIHttaW50RnJvbUNvbGxlY3Rpb246ICJtaW50cyBhIHRva2VuIGZvciB0aGUgY2FsbGVyIn0sIAogICAgICAgICAgICAgICAge21pbnRNZW1iZXJzaGlwOiAibWludHMgYSBuZXcgbWVtYmVyc2hpcCB0b2tlbiBmb3IgY2FsbGVyIn0sCiAgICAgICAgICAgICAgICB7dHJhbnNmZXI6ICJ0cmFuc2ZlcnMgYXNzZXQgZnJvbSBjYWxsZXIgdG8gYW5vdGhlciBhZGRyZXNzIn0sIAogICAgICAgICAgICAgICAge3RyYW5zZmVyTWVtYmVyc2hpcDogInRyYW5zZmVycyB0aGUgY2FsbGVycyBtZW1iZXJzaGlwIHRva2VuIn0sCiAgICAgICAgICAgICAgICB7dXBkYXRlTWVtYmVyU2V0dGluZ3M6ICJVcGRhdGVzIHRoZSBzZXR0aW5ncyBrZXkgaW4gdGhlIG1lbWJlcnMgdG9rZW4ifSwKICAgICAgICAgICAgICAgIHt1cGRhdGVNZW1iZXJBdmF0YXI6ICJ1cGRhdGVzIHRoZSB1cmwgbG9jYXRpb24gb2YgdGhlIG1lbWJlcnMgYXZhdGFyIHBpY3R1cmUifSwKICAgICAgICAgICAgICAgIHt1cGRhdGVNZW1iZXJTY29yZTogInVwZGF0ZXMgdGhlIG1lbWJlcnMgc2NvcmUgKHdpbnMsbG9zc2VzLHN0YWxlbWF0ZXMsdG90YWwgZ2FtZXMpIGluIHRoZSBtZW1iZXJzIHRva2VuIn0sCiAgICAgICAgICAgICAgICB7dXBkYXRlTWVtYmVyTGV2ZWw6ICJ1cGRhdGVzIHRoZSBtZW1iZXJzIGxldmVsIGluIHRoZSBtZW1iZXJzIHRva2VuIn0sCiAgICAgICAgICAgICAgICB7YnVybkFzc2V0OiAiYnVybnMgYSBjcmVhdGVkIGFzc2V0IC0gb25seSBhdmFpbGFibGUgb24gbm9uLW9yaWdpbmFsIGFzc2V0cyBhbmQgbWVtYmVyc2hpcCB0b2tlbnMifSwgCiAgICAgICAgICAgICAgICB7YnVybkNvbGxlY3Rpb246ICJCdXJucyBhIGNvbGxlY3Rpb24gYW5kIGFsbCB0aGUgYXNzZXRzIGluIGl0LCBpZiB0aGUgY29sbGVjdGlvbiBpcyBidXJuYWJsZSJ9LCAKICAgICAgICAgICAgICAgIHtidXJuTWVtYmVyc2hpcDogIkJ1cm5zIHRoZSBjYWxsZXJzIG1lbWJlcnNoaXAgdG9rZW4ifSwKICAgICAgICAgICAgICAgIHt0cmFuc2Zlck93bmVyc2hpcDogInRyYW5zZmVycyBvd25lcnNoaXAgb2YgdGhpcyBjb250cmFjdCB0byBhbm90aGVyIGFkZHJlc3MifSwgCiAgICAgICAgICAgICAgICB7Y29udHJhY3RPd25lcjogInJldHVybnMgd2hvIG93bnMgdGhpcyBjb250cmFjdCJ9CiAgICAgICAgICAgIF0gfQogICAgICAgIH0KICAgICAgICBjYXNlICdhbGxBc3NldHMnOiB7IC8vIHJldHVybnMgYWxsIGFzc2V0cyBpbiB0aGlzIGNvbnRyYWN0CiAgICAgICAgICAgIHJldHVybiB7cmVzdWx0OiBPYmplY3Qua2V5cyhzdGF0ZS5hc3NldHMpLm1hcChjb2xsZWN0aW9uID0-IE9iamVjdC5rZXlzKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5hc3NldHMpKX0KICAgICAgICB9CiAgICAgICAgY2FzZSAiZ2V0QXNzZXRzT3duZWRCeUNhbGxlciIgOiB7IC8vIGdldHMgYWxsIG5mdHMgb3duZXIgYnkgY2FsbGVyLCByZXR1cm5zIHRoZSBjb2xsZWN0aW9uLCBuZnQsIGFuZCB0cnVlIG9yIGZhbHNlIGZvciBpZiB0aGV5IGhhdmUgaXQKICAgICAgICAgICAgICAgIGxldCBvd25lZEFzc2V0cyA9IE9iamVjdC5rZXlzKHN0YXRlLmFzc2V0cykubWFwKGNvbGxlY3Rpb24gPT4gT2JqZWN0LmtleXMoc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLmFzc2V0cykubWFwKGFzc2V0ID0-IHtpZihzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl1bYXNzZXRdLm93bmVycy5pbmNsdWRlcyhhY3Rpb24uY2FsbGVyKSA9PT0gZmFsc2Upe3JldHVybiB7W2NvbGxlY3Rpb25dOntbYXNzZXRdOiBmYWxzZX19fWVsc2V7cmV0dXJuIHtbY29sbGVjdGlvbl06e1thc3NldF06IHRydWV9fX19KSk7CiAgICAgICAgICAgICAgICByZXR1cm4ge3Jlc3VsdCA6IG93bmVkQXNzZXRzfQogICAgICAgIH0KICAgICAgICBjYXNlICJnZXRPd25lcnMiOiB7IC8vcmV0dXJucyBhbGwgb3duZXJzIG9mIHRoYXQgYXNzZXQKICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGFjdGlvbi5pbnB1dC5kYXRhLmNvbGxlY3Rpb24KICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBhY3Rpb24uaW5wdXQuZGF0YS5hc3NldDsKICAgICAgICAgICAgaWYgKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5hc3NldHNbYXNzZXRdKSB7CiAgICAgICAgICAgIHJldHVybiB7IHJlc3VsdDogc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dW2Fzc2V0XS5vd25lcnMgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiBgVGhhdCBhc3NldCBkb2VzIG5vdCBleGlzdGAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXNlICJnZXRBc3NldERhdGEiIDogeyAvLyByZXR1cm5zIGFsbCBkYXRhIHRoYXQgYXNzZXQgaG9sZHMgKG5hbWUsIG93bmVycywgYnVybmFibGUsIGZpbGUgdXJscywgZXRjKQogICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gYWN0aW9uLmlucHV0LmRhdGEuY29sbGVjdGlvbgogICAgICAgICAgICBjb25zdCBhc3NldCA9IGFjdGlvbi5pbnB1dC5kYXRhLmFzc2V0CiAgICAgICAgICAgIGlmIChzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0pewogICAgICAgICAgICAgICAgcmV0dXJuIHtyZXN1bHQgOiBzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0uYXNzZXRzW2Fzc2V0XX0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKGBUaGF0IGFzc2V0IGRvZXMgbm90IGV4aXN0YCkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgY2FzZSAiZ2V0QXNzZXRzSW5Db2xsZWN0aW9uIiA6IHsgLy8gcmV0dXJucyBhbGwgYXNzZXRzIGluIGEgY29sbGVjdGlvbiBieSBrZXkgbmFtZXMKICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGFjdGlvbi5pbnB1dC5kYXRhLmNvbGxlY3Rpb24KICAgICAgICAgICAgaWYgKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXSl7CiAgICAgICAgICAgICAgICByZXR1cm4ge3Jlc3VsdCA6IE9iamVjdC5rZXlzKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5hc3NldHMpfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhc2UgInRyYW5zZmVyIjogeyAvLyB0cmFuc2ZlcnMgYXNzZXQgZnJvbSBvbmUgcGVyc29uIHRvIGFub3RoZXIKICAgICAgICAgICAgY29uc3QgdG9BZGRyZXNzID0gYWN0aW9uLmlucHV0LmRhdGEudG87CiAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYWN0aW9uLmlucHV0LmRhdGEuYXNzZXQ7CiAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBhY3Rpb24uaW5wdXQuZGF0YS5jb2xsZWN0aW9uCiAgICAgICAgICAgIGlmICghc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLmFzc2V0c1thc3NldF0ub3duZXJzLmluY2x1ZGVzKGFjdGlvbi5jYWxsZXIpKSB7IC8vIGNoZWNrIGlmIHVzZXIgb3ducyB0aGF0IHRva2VuCiAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKCJTZW5kZXIgZG9lcyBub3Qgb3duIHRoYXQgdG9rZW4sIGNhbm5vdCB0cmFuc2ZlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5hc3NldHNbYXNzZXRdLm93bmVycyA9IGRlbGV0ZSBhY3Rpb24uY2FsbGVyOwogICAgICAgICAgICBzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0uYXNzZXRzW2Fzc2V0XS5vd25lcnMucHVzaCh0b0FkZHJlc3MpOwogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9OwogICAgICAgIH0KICAgICAgICBjYXNlICJjcmVhdGVBc3NldCIgOiB7IC8vIGNyZWF0ZXMgYSBuZXcgYXNzZXQvdG9rZW4gaW4gdGhlIGNvbnRyYWN0CiAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBhY3Rpb24uaW5wdXQuZGF0YS5jb2xsZWN0aW9uCiAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYWN0aW9uLmlucHV0LmRhdGEuYXNzZXQ7CiAgICAgICAgICAgIGlmKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXSl7CiAgICAgICAgICAgICAgICBpZihzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0uYXNzZXRzW2Fzc2V0XSl7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigKICAgICAgICAgICAgICAgICAgICAndGhhdCBhc3NldCBhbHJlYWR5IGV4aXN0cycKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLmFzc2V0c1thc3NldC5uYW1lXSA9IGFzc2V0CiAgICAgICAgICAgIH19ZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgQ29sbGVjdGlvbiBkb2VzIG5vdCBleGlzdCwgY3JlYXRlIGNvbGxlY3Rpb24gYmVmb3JlIGNyZWF0aW5nIGFuIGFzc2V0YCkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9IAogICAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgY2FzZSAiY3JlYXRlQ29sbGVjdGlvbiIgOiB7IC8vIGNyZWF0ZSBjb2xsZWN0aW9uIGluIHRoZSBjb250cmFjdAogICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gYWN0aW9uLmlucHV0LmRhdGEuY29sbGVjdGlvbgogICAgICAgICAgICBpZihzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0pewogICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgY29sbGVjdGlvbiBhbHJlYWR5IGV4aXN0c2ApfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXSA9IGNvbGxlY3Rpb24KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9CiAgICAgICAgfQogICAgICAgIGNhc2UgImJ1cm5Db2xsZWN0aW9uIiA6IHsgLy9idXJucyBlbnRpcmUgY29sbGVjdGlvbgogICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gYWN0aW9uLmlucHV0LmRhdGEuY29sbGVjdGlvbgogICAgICAgICAgICBpZihzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0pewogICAgICAgICAgICAgICAgaWYoc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLm93bmVycyA9PT0gYWN0aW9uLmNhbGxlcil7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5idXJuYWJsZSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoYENvbGxlY3Rpb24gaXMgbm90IGJ1cm5hYmxlYCkKICAgICAgICAgICAgfX1lbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKGBPbmx5IHRoZSBvd25lciBvZiBhIGNvbGxlY3Rpb24gY2FuIGJ1cm4gdGhhdCBjb2xsZWN0aW9uYCkKICAgICAgICAgICAgfX0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgQ29sbGVjdGlvbiBkb2VzIG5vdCBleGlzdGApCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgc3RhdGUgfQogICAgICAgIH0KICAgICAgICBjYXNlICJtaW50RnJvbUNvbGxlY3Rpb24iOiB7IC8vYWRkIHVzZXIgdG8gb3duZXJzIGxpc3QgZm9yIGFzc2V0IChtaW50cyBhIHRva2VuIGZvciB0aGF0IHVzZXIpCiAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBhY3Rpb24uaW5wdXQuZGF0YS5jb2xsZWN0aW9uCiAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYWN0aW9uLmlucHV0LmRhdGEuYXNzZXQ7CiAgICAgICAgICAgIGlmIChzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0uYXNzZXRzW2Fzc2V0XSl7Ly9jaGVja3MgaWYgYXNzZXQgZXhpc3RzLCBpZiBpdCBkb2VzbnQgaXQgdGhyb3dzIGFuIGVycm9yCgogICAgICAgICAgICBpZiAoIXN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5hc3NldHNbYXNzZXRdLm93bmVycy5pbmNsdWRlcyhhY3Rpb24uY2FsbGVyKSkgeyAvL2NoZWNrIGlmIHVzZXIgYWxyZWFkeSBvd25zIHRoYXQgYXNzZXQsIGlmIHRoZXkgZG8gdGhyb3dzIGFuIGVycm9yIAogICAgICAgICAgICAgc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLmFzc2V0c1thc3NldF0ub3duZXJzLnB1c2goYWN0aW9uLmNhbGxlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgQ2FuIG9ubHkgb3duIG9uZSBvZiB0aGF0IG5mdCwgc29ycnkhYCkKICAgICAgICAgICAgfQogICAgICAgIAogICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKGBUaGF0IGFzc2V0IGRvZXMgbm90IGV4aXN0YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgc3RhdGUgfTsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgIm1pbnRNZW1iZXJzaGlwIiA6IHsgLy8gbWludHMgYSBuZXcgbWVtYmVyc2hpcCB0b2tlbiBmb3IgdGhlIGNhbGxlcgogICAgICAgICAgICBjb25zdCBhc3NldCA9IGFjdGlvbi5pbnB1dC5kYXRhLmFzc2V0OwogICAgICAgICAgICBjb25zdCBtZW1iZXIgPSBhY3Rpb24uY2FsbGVyCiAgICAgICAgICAgIGlmICghc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbbWVtYmVyXSl7Ly9jaGVja3MgaWYgYXNzZXQgZXhpc3RzLCBpZiBpdCBkb2VzIGl0IHRocm93cyBhbiBlcnJvcgogICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbbWVtYmVyXSA9IGFzc2V0CiAgICAgICAgCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKGBZb3UgYWxyZWFkeSBvd24gYSBtZW1iZXJzaGlwIHRva2VuLCB5b3UgY2FuIG9ubHkgb3duIG9uZS5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9OwogICAgICAgICAgCiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJ1cGRhdGVNZW1iZXJTZXR0aW5ncyIgOiB7IC8vIGNoYW5nZXMgdGhlIG1lbWJlcnMgc2V0dGluZ3MKICAgICAgICAgICAgICBjb25zdCBtZW1iZXIgPSBhY3Rpb24uY2FsbGVyCiAgICAgICAgICAgICAgY29uc3QgbmV3U2V0dGluZ3MgPSBhY3Rpb24uaW5wdXQuZGF0YS5uZXdTZXR0aW5ncwogICAgICAgICAgICAgIGlmKHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0pewogICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbbWVtYmVyXS5zZXR0aW5ncyA9IG5ld1NldHRpbmdzCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoYFlvdSBuZWVkIHRvIG1pbnQgYSBtZW1iZXJzaGlwIGJlZm9yZSBjaGFuZ2luZyB5b3VyIHNldHRpbmdzYCkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdGUgfQoKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgInVwZGF0ZU1lbWJlckF2YXRhciIgOiB7IC8vIGNoYW5nZXMgbWVtYmVycyBhdmF0YXIKICAgICAgICAgICAgY29uc3QgbWVtYmVyID0gYWN0aW9uLmNhbGxlcgogICAgICAgICAgICAgIGNvbnN0IG5ld0F2YXRhciA9IGFjdGlvbi5pbnB1dC5kYXRhLm5ld0F2YXRhcgogICAgICAgICAgICAgIGlmKHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0pewogICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbbWVtYmVyXS5hdmF0YXIgPSBuZXdBdmF0YXIKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgWW91IG5lZWQgdG8gbWludCBhIG1lbWJlcnNoaXAgYmVmb3JlIGNoYW5naW5nIHlvdXIgQXZhdGFyYCkKICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgIHJldHVybiB7IHN0YXRlIH0KICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGNhc2UgInVwZGF0ZU1lbWJlclNjb3JlIiA6IHsgLy8gY2hhbmdlcyBtZW1iZXJzIHNjb3JlCiAgICAgICAgICAgICAgY29uc3QgbWVtYmVyID0gYWN0aW9uLmNhbGxlcgogICAgICAgICAgICAgIGNvbnN0IG5ld1Njb3JlID0gYWN0aW9uLmlucHV0LmRhdGEubmV3U2NvcmUKICAgICAgICAgICAgICAgIGlmKHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0pewogICAgICAgICAgICAgICAgICAgIHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0uc2NvcmUgPSBuZXdTY29yZQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgWW91IG5lZWQgdG8gbWludCBhIG1lbWJlcnNoaXAgYmVmb3JlIGNoYW5naW5nIHlvdXIgc2NvcmVgKQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9CiAgICAgICAgICAgIAogICAgICAgIH0KICAgICAgICBjYXNlICJ1cGRhdGVNZW1iZXJMZXZlbCIgOiB7IC8vIGNoYW5nZXMgbWVtYmVycyBMZXZlbAogICAgICAgICAgICBjb25zdCBtZW1iZXIgPSBhY3Rpb24uY2FsbGVyCiAgICAgICAgICAgICAgY29uc3QgbmV3TGV2ZWwgPSBhY3Rpb24uaW5wdXQuZGF0YS5uZXdMZXZlbAogICAgICAgICAgICAgIGlmKHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0pewogICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbbWVtYmVyXS5sZXZlbCA9IG5ld0xldmVsCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoYFlvdSBuZWVkIHRvIG1pbnQgYSBtZW1iZXJzaGlwIGJlZm9yZSBjaGFuZ2luZyB5b3VyIGxldmVsYCkKICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgIHJldHVybiB7IHN0YXRlIH0KICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGNhc2UgInRyYW5zZmVyTWVtYmVyc2hpcCIgOiB7IC8vdHJhbnNmZXJzIG1lbWJlcnNoaXAgdG8gYW5vdGhlciBhY2NvdW50CiAgICAgICAgICAgIGNvbnN0IGZyb21BZGRyZXNzID0gYWN0aW9uLmNhbGxlcgogICAgICAgICAgICBjb25zdCB0b0FkZHJlc3MgPSBhY3Rpb24uaW5wdXQuZGF0YS50bwogICAgICAgICAgICBjb25zdCB0b2tlbkRldGFpbHMgPSBzdGF0ZS5hc3NldHMubWVtYmVyc2hpcFRva2VuLmFzc2V0c1tmcm9tQWRkcmVzc10KCiAgICAgICAgICAgIGlmIChzdGF0ZS5hc3NldHMubWVtYmVyc2hpcFRva2VuLmFzc2V0c1tmcm9tQWRkcmVzc10peyAvLyBjaGVja3MgaWYgdGhhdCB0b2tlbiBleGlzdHMKICAgICAgICAgICAgICAgIHtpZiAoIXN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW3RvQWRkcmVzc10peyAvLyBjaGVja3MgaWYgdG9rZW4gY2FuIGJlIHRyYW5zZmVyZWQgdG8gdGhlIHRvQWRkcmVzcwogICAgICAgICAgICAgICBkZWxldGUgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbZnJvbUFkZHJlc3NdCiAgICAgICAgICAgICAgIHN0YXRlLmFzc2V0cy5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW3RvQWRkcmVzc10gPSB0b2tlbkRldGFpbHMKICAgICAgICAgICAgICAgc3RhdGUuYXNzZXRzLm1lbWJlcnNoaXBUb2tlbi5hc3NldHNbdG9BZGRyZXNzXS5vd25lcnMgPSB0b0FkZHJlc3MKCiAgICAgICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKGBZb3UgY2FudCB0cmFuc2ZlciB0aGF0IHRva2VuIHRvICR7dG9BZGRyZXNzfSBiZWNhdXNlIHRoZXkgYWxyZWFkeSBvd24gYSBtZW1iZXJzaGlwVG9rZW4gYCkKICAgICAgICAgICAgfQogICAgICAgIH19ZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgWW91IGRvbnQgb3duIGEgbWVtYmVyc2hpcFRva2VuIHRvIHRyYW5zZmVyLmApCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgc3RhdGUgfQogICAgICAgIH0KICAgICAgICBjYXNlICJidXJuTWVtYmVyc2hpcCIgOiB7IC8vIGJ1cm5zIG1lbWJlcnNoaXAgdG9rZW4KICAgICAgICAgICAgY29uc3QgbWVtYmVyID0gYWN0aW9uLmNhbGxlcgogICAgICAgICAgICBpZiAoc3RhdGUuYXNzZXQubWVtYmVyc2hpcFRva2VuLmFzc2V0c1ttZW1iZXJdKXsKICAgICAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5hc3NldC5tZW1iZXJzaGlwVG9rZW4uYXNzZXRzW21lbWJlcl0KICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoYENhbm5vdCBidXJuIHRoYXQgdG9rZW4sIGl0IGRvZXMgbm90IGV4aXN0YCkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9IAogICAgICAgIH0KICAgICAgICAgIGNhc2UgJ2J1cm5Bc3NldCcgOiB7IC8vZGVsZXRlcyBhc3NldCBmcm9tIGNvbnRyYWN0LCBvbmx5IGF2YWlsYWJsZSBmb3Igbm9uLXByZXNldCBhc3NldHMKICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGFjdGlvbi5pbnB1dC5kYXRhLmNvbGxlY3Rpb24KICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBhY3Rpb24uaW5wdXQuZGF0YS5hc3NldDsKICAgICAgICAgICAgaWYgKGFjdGlvbi5jYWxsZXIgPT09IHN0YXRlLmFzc2V0c1tjb2xsZWN0aW9uXS5vd25lcnMpewogICAgICAgICAgICAgICAgaWYoc3RhdGUuYXNzZXRzW2NvbGxlY3Rpb25dLmFzc2V0c1thc3NldF0uYnVybmFibGUgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKAogICAgICAgICAgICAgICAgICAgIGBhc3NldCBpcyBub3QgYnVybmFibGVgCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5hc3NldHNbY29sbGVjdGlvbl0uYXNzZXRzW2Fzc2V0XQogICAgICAgICAgICB9fWVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoYFlvdSBtdXN0IGJlIHRoZSBvd25lciBvZiB0aGUgY29sbGVjdGlvbiB0byBidXJuIGFuIGFzc2V0YCkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyBzdGF0ZSB9CgogICAgICAgICAgfQogICAgICAgICAgY2FzZSAnY29udHJhY3RPd25lcicgOiB7IC8vcmV0dXJucyB3aG8gb3ducyB0aGUgY29udHJhY3QKICAgICAgICAgICAgICByZXR1cm4geyByZXN1bHQgOiBzdGF0ZS5vd25lcn0KICAgICAgICAgIH0KCiAgICAgICAgICBjYXNlICJ0cmFuc2Zlck93bmVyc2hpcCIgOiB7IC8vIHRyYW5zZmVycyBvd25lcnNoaXAgb2YgdGhlIGNvbnRyYWN0CiAgICAgICAgICAgIGlmIChhY3Rpb24uY2FsbGVyICE9PSBzdGF0ZS5vd25lcil7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgWW91IGNhbm5vdCB0cmFuc2ZlciB0aGF0IHdoaWNoIHlvdSBkbyBub3Qgb3duYCkKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgc3RhdGUub3duZXIgPSBhY3Rpb24uaW5wdXQuZGF0YS5uZXdPd25lcjsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgc3RhdGUgfQogICAgICAgICAgfQogICAgICAgIAogICAgICAKICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcihgVW5zdXBwb3J0ZWQgY29udHJhY3QgZnVuY3Rpb246ICR7ZnVuY3Rpb25OYW1lfWApOwogICAgICAgIH0KICAgICAgfQoKCgp9Cgo